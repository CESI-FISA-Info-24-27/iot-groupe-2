# ğŸ§© Backend â€“ EcoGuard 360

Ce dossier contient le **backend Edge** du projet **EcoGuard 360**. Il constitue le cÅ“ur logiciel de la Gateway (Raspberry Pi) et assure la **convergence des flux IoT** : tÃ©lÃ©mÃ©trie capteurs, commandes actionneurs, stockage time-series et diffusion temps rÃ©el vers lâ€™application mobile.

---

## ğŸ¯ RÃ´le du backend

Le backend a pour responsabilitÃ©s principales :

- ğŸ“¡ **Consommer les donnÃ©es terrain** publiÃ©es sur MQTT
- ğŸ—„ï¸ **Stocker les sÃ©ries temporelles** dans InfluxDB
- ğŸ” **Exposer une API REST** pour lâ€™historique et le contrÃ´le
- âš¡ **Diffuser les mises Ã  jour temps rÃ©el** via WebSocket
- ğŸ§  Servir de **couche dâ€™abstraction** entre le monde terrain (BLE/WiFi) et le frontend mobile

Le backend est **agnostique des protocoles capteurs** (BLE/WiFi) et ne consomme que des messages MQTT normalisÃ©s.

---

## ğŸ§± Stack technique

| Composant        | Technologie             |
| ---------------- | ----------------------- |
| Runtime          | Node.js 20              |
| Framework API    | Express (CommonJS)      |
| Message Bus      | MQTT (Mosquitto)        |
| Base de donnÃ©es  | InfluxDB 2.x            |
| Temps rÃ©el       | WebSocket (`ws`)        |
| Conteneurisation | Docker / Docker Compose |

---

## ğŸ“ Structure du dossier

```bash
backend/
 â”œâ”€ src/
 â”‚   â”œâ”€ index.js              # EntrÃ©e serveur HTTP + wiring services
 â”‚   â”œâ”€ app.js                # App Express (middlewares + routes)
 â”‚   â”œâ”€ config/
 â”‚   â”‚   â””â”€ env.js             # Centralisation des variables dâ€™environnement
 â”‚   â”œâ”€ routes/
 â”‚   â”‚   â””â”€ sensors.routes.js  # Endpoints capteurs & actionneurs
 â”‚   â”œâ”€ services/
 â”‚   â”‚   â”œâ”€ mqtt.service.js    # Client MQTT (connect, subscribe, publish)
 â”‚   â”‚   â””â”€ influx.service.js  # Client InfluxDB (write/query/health)
 â”‚   â””â”€ websocket/
 â”‚       â””â”€ ws.js              # Serveur WebSocket
 â”œâ”€ Dockerfile
 â”œâ”€ docker-compose.yml
 â”œâ”€ .env.example
 â””â”€ package.json
```

---

## ğŸ”— Flux de donnÃ©es

### ChaÃ®ne tÃ©lÃ©mÃ©trie (critique)

```
ESP32 (BLE) â†’ Bridge Python (Pi) â†’ MQTT â†’ Backend â†’ InfluxDB â†’ API /history â†’ Mobile
```

### ChaÃ®ne commande actionneur

```
Mobile â†’ API /action â†’ MQTT â†’ Bridge Python â†’ BLE Write â†’ Actionneur
```

---

## ğŸ“¡ Convention MQTT

### Topic tÃ©lÃ©mÃ©trie

```
sensors/<sensor_id>/telemetry
```

### Payload attendu

```json
{
  "room": "room1",
  "sensor_id": "sense-01",
  "metric": "temperature",
  "value": 23.4,
  "ts": 1768381684000
}
```

---

## ğŸ—„ï¸ ModÃ¨le InfluxDB

- **Measurement** : `telemetry`
- **Tags** : `room`, `sensor_id`, `metric`
- **Field** : `value`
- **Time** : `ts` (ms, fallback sur `Date.now()`)

Ce modÃ¨le permet des requÃªtes efficaces pour lâ€™historique et lâ€™analyse temporelle.

---

## ğŸŒ API HTTP

### Health check

```http
GET /health
```

Retourne lâ€™Ã©tat des dÃ©pendances :

```json
{
  "status": "healthy",
  "services": {
    "mqtt": "up",
    "influxdb": "up"
  }
}
```

---

### Historique capteurs

```http
GET /api/sensors/history?sensor=temperature&room=room1&range=24h
```

---

### Commande actionneur

```http
POST /api/sensors/action
Content-Type: application/json
```

```json
{
  "target": "led1",
  "state": "ON",
  "room": "room1"
}
```

---

## âš¡ WebSocket

- Endpoint : `/ws`
- Usage : diffusion temps rÃ©el des Ã©vÃ©nements tÃ©lÃ©mÃ©trie

Exemple de message :

```json
{
  "type": "telemetry",
  "sensor_id": "sense-01",
  "metric": "temperature",
  "value": 23.4,
  "ts": 1768381684000
}
```

---

## ğŸ³ Lancement avec Docker

### PrÃ©parer lâ€™environnement

CrÃ©er un fichier `.env` (non commitÃ©) Ã  partir de `.env.example`.

### DÃ©marrer la stack complÃ¨te

```bash
docker-compose up -d --build
```

### Logs

```bash
docker-compose logs -f api
```

---

## ğŸ§ª Tests rapides

### Publier une donnÃ©e MQTT

```bash
mosquitto_pub -h localhost -p 1883 -t sensors/sense-01/telemetry \
  -m '{"room":"room1","sensor_id":"sense-01","metric":"temperature","value":23.4}'
```

### VÃ©rifier lâ€™historique

```bash
curl "http://localhost:8000/api/sensors/history?sensor=temperature&room=room1&range=1h"
```

---

## ğŸ” SÃ©curitÃ© (MVP)

- Secrets gÃ©rÃ©s via variables dâ€™environnement
- Aucun mot de passe en dur dans le code
- Mosquitto configurÃ© en `allow_anonymous true` pour le MVP

> Une Ã©volution vers ACL + authentification est prÃ©vue.

---

## ğŸ‘¨â€ğŸ’» RÃ´le projet

Ce backend a Ã©tÃ© conÃ§u et implÃ©mentÃ© dans le cadre du rÃ´le **Backend Architect**.
Il est prÃªt Ã  Ãªtre consommÃ© par :

- le **bridge BLE â†” MQTT** (Edge Ops Lead)
- lâ€™**application mobile** (Mobile & UX Lead)

---

ğŸŸ¢ **Backend EcoGuard 360 â€” prÃªt pour lâ€™intÃ©gration terrain**
